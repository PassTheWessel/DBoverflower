"use strict";const zlib=require("zlib"),{parse:UrlParse,resolve:UrlResolve}=require("url"),socket=require("./socket"),Stream=require("stream"),querystring=require("querystring"),{METHODS:METHODS,STATUS_CODES:STATUS_CODES}=require("http"),FormData=require("./FormData");function shouldUnzip(e,t){return 204!==e&&304!==e&&(0!=+t["content-length"]&&/^\s*(?:deflate|gzip)\s*$/.test(t["content-encoding"]))}function request(e,t=e.options){return new Promise(async(n,r)=>{Object.assign(t,UrlParse(t.url)),t.headers["user-agent"]||(t.headers["user-agent"]="Snek/4.0.4");let o,{data:s}=t;if(s&&s.end&&(s=s.end()),!t.headers["content-length"]){let e=0;if(s)try{e=Buffer.byteLength(s)}catch(e){}t.headers["content-length"]=e}let c=!1;try{if(t.connection&&t.connection.port===t.port&&t.connection.host===t.host)o=socket.http2req(t.connection,t),c=!0;else{const e=await socket(t);({req:o}=e),e.http2&&(c=!0),e.connection&&(t.connection=e.connection)}}catch(e){return void r(e)}o.once("error",r);const i=[];let a,u,l;const d=s=>{if("follow"===t.redirect&&[301,302,303,307,308].includes(u))return n(request(e,Object.assign({},t,{url:UrlResolve(t.url,a.location)}))),void(o.abort?o.abort():o.close&&o.close());s.once("error",r),shouldUnzip(u,a)&&(s=s.pipe(zlib.createUnzip({flush:zlib.Z_SYNC_FLUSH,finishFlush:zlib.Z_SYNC_FLUSH}))).once("error",r),s.on("data",t=>{e.push(t)||e.pause(),i.push(t)}),s.once("end",()=>{e.push(null);const r=Buffer.concat(i);t.connection&&t.connection.close&&t.connection.close(),n({raw:r,headers:a,statusCode:u,statusText:l})})};o.on("response",e=>{c?(u=e[":status"],l=STATUS_CODES[u],a=e,d(o)):(l=e.statusMessage||STATUS_CODES[u],({headers:a,statusCode:u}=e),d(e))}),s instanceof Stream?s.pipe(o):s instanceof Buffer?o.write(s):s&&o.write(s),o.end()})}module.exports={request:request,shouldSendRaw:e=>e instanceof Buffer||e instanceof Stream,querystring:querystring,METHODS:METHODS,FormData:FormData,Parent:Stream.Readable};